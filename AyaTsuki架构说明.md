# AyaTsuki架构说明

## AyaTsuki简介

AyaTsuki是一款使用RISC-V内核的MCU，主要组成部分为RISC-V RV32I Core，TIM系统时钟以及UART系统标准串行通讯口

## 内核说明

### 流水线

AyaTsuki出于没有内存访问延迟的考虑，取消掉了第四层单独的访存的阶段，因此AyaTsuki的核心只有4层流水线。此外，减少流水线的层数可以有效减少分支预测失败带来的气泡延迟，并且能减少数据转发的层数和指令冲突的问题。因此AyaTsuki选用了四级流水线的设计思路。

### 内核指令集

CPU的内核支持RV32I最小指令集，暂时不支持RV32I中的ebreak和ecall两个特殊状态指令，并且当前没有完成外部中断以及内部软件中断、CPU特殊特权状态的功能，因此当前CPU仅仅有机器模式。

### 分支预测

AyaTsuki在PC取值层具有分支预测功能，它内部具有一个存储容量为3block的缓存，它可以缓存三次CPU获取到的跳转指令，并且根据分支预测的跳转结果来修改缓存内部的分支预测期望，借助指令的马尔可夫性质来使CPU预测跳转的准确性。

## 外设说明

AyaTsuki通过一对多RIB总线实现了通过内存访问的机制来控制的外设组，当前MCU实现了TIM时钟外设和UART串行通讯接口

外设的内存地址从0x10000000开始编址，以方便外设读写时内存访问的方便性

### TIM系统时钟

TIM系统时钟拥有两个寄存器，分别为 tim_cnt 和 tim_conf 寄存器，具体说明如下

|寄存器|地址|功能|
|:-:|:-:|:-:|
|tim_cnt|0x10000000|系统定时时钟，速度和CPU内核保持一致
|tim_conf|0x10000004|定时时钟设置寄存器

#### 寄存器说明

##### tim_cnt

地址：0x10000000
读写：读返回当前系统时间，写入无效
位宽：32bit

##### tim_conf

地址：0x10000004
读写：读写均可
位宽：32bit
位说明：
tim_conf[15:0] 中断计数器溢出数值
tim_conf[23:16] 中断计数器预分频值
tim_conf[24] 允许发出中断请求

### UART通讯串口

UART串口具有四个寄存器，分别为 uart_tx，uart_rx，uart_status 和 uart_conf 寄存器，具体说明如下

|寄存器|地址|功能|
|:-:|:-:|:-:|
|uart_tx|0x10000100|串口发送寄存器，当写入该寄存器时立刻开始发送
|uart_rx|0x10000104|串口接收寄存器，存有上一次接收数据，第一次读取数据无效（待完成）
|uart_status|0x10000108|串口状态寄存器（待完成）
|uart_conf|0x1000010C|串口设置寄存器（待完成）

##### uart_tx

地址：0x10000100
读写：读写均可，写入触发发送
位宽：32bit，低8位可用

##### uart_rx

地址：0x10000104
读写：若接收到数据，则读出接收数据，否则读入数据无效，写入无效
位宽：32bit，低8位可用

##### uart_status

地址：0x10000108
读写：只读，写无效
位宽：32bit
位说明：
uart_status[0] 发送忙
uart_status[1] 接收完成，读取rx后自动清零

... 未完待续